<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTF to Word 変換くん</title>
    <script src="https://cdn.jsdelivr.net/npm/pandoc-wasm@0.1.7/dist/index.browser.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f9; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        h1 { color: #333; font-size: 1.5rem; margin-bottom: 1.5rem; }
        #drop-zone { border: 2px dashed #007bff; border-radius: 8px; padding: 40px 20px; cursor: pointer; transition: background 0.3s; color: #007bff; margin-bottom: 1rem; }
        #drop-zone:hover { background: #eef6ff; }
        #status { margin-top: 1rem; color: #555; font-size: 0.9rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>RTF to Word 変換</h1>
    <div id="drop-zone">ここにRTFファイルをドロップ<br>(またはクリックして選択)</div>
    <input type="file" id="file-input" style="display:none" accept=".rtf">
    <div id="loader" class="loader"></div>
    <div id="status">ファイルを選択してください</div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');

    // クリックでファイル選択を開く
    dropZone.onclick = () => fileInput.click();

    // ファイルが選択された時の処理
    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    // ドラッグ＆ドロップの処理
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = "#eef6ff"; };
    dropZone.ondragleave = () => { dropZone.style.background = "none"; };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.style.background = "none";
        handleFile(e.dataTransfer.files[0]);
    };

    async function handleFile(file) {
        if (!file) return;
        if (!file.name.endsWith('.rtf')) {
            status.innerText = "エラー: RTFファイルを選択してください";
            return;
        }

        status.innerText = "変換エンジンを起動中...";
        loader.style.display = "block";

        try {
            // Pandocの初期化
            const pandoc = new PandocWasm.Pandoc();
            
            // ファイルの読み込み
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            // 変換実行 (RTF -> DOCX)
            // 日本語ANSI(CP932)はPandocが内部の \ansicpg932 を見て自動判別します
            const result = await pandoc.run({
                text: uint8Array,
                from: "rtf",
                to: "docx",
                options: [],
                files: { "input.rtf": uint8Array }
            });

            // ダウンロード処理
            const blob = new Blob([result.data], { type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name.replace(/\.rtf$/i, '.docx');
            a.click();
            
            status.innerText = "変換成功！保存されました。";
        } catch (error) {
            console.error(error);
            status.innerText = "エラーが発生しました: " + error.message;
        } finally {
            loader.style.display = "none";
        }
    }
</script>

</body>
</html>
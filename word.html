<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>RTF to Word 変換 V5</title>
    <style>
        body { font-family: sans-serif; background-color: #fce4ec; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #d81b60; font-size: 1.4rem; }
        #drop-zone { border: 3px dashed #f06292; border-radius: 12px; padding: 50px 20px; cursor: pointer; color: #d81b60; background: #fff1f5; font-weight: bold; }
        #status { margin-top: 1.5rem; font-size: 0.9rem; color: #880e4f; }
        #result-area { display: none; margin-top: 20px; }
        .download-btn { display: inline-block; text-decoration: none; background: #d81b60; color: white; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>RTF → Word (V5)</h1>
    <p style="font-size: 0.8rem; color: #666;">エンジン不要・直接変換方式</p>
    <div id="drop-zone">ここにRTFファイルをドロップ</div>
    <input type="file" id="file-input" style="display:none" accept=".rtf">
    
    <div id="status">準備完了</div>
    
    <div id="result-area">
        <a id="download-link" class="download-btn">Word形式(.docx)で保存</a>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const resultArea = document.getElementById('result-area');
    const downloadLink = document.getElementById('download-link');

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = "#f8bbd0"; };
    dropZone.ondragleave = () => { dropZone.style.background = "#fff1f5"; };
    dropZone.ondrop = (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };

    async function handleFile(file) {
        if (!file) return;
        status.innerText = "読み込み中...";
        resultArea.style.display = "none";

        try {
            // 1. RTFファイルをテキストとして読み込む
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                // 2. Wordが解釈できるHTML形式のDocxデータを作成
                // 日本語ANSI(Shift-JIS)対応のためcharsetを指定したHTMLを生成
                const htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head><meta charset='utf-8'></head>
                    <body>${convertRtfToPseudoHtml(content)}</body>
                    </html>`;

                // 3. Blobを作成（Word文書として認識させる）
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                // 4. ダウンロード準備
                const url = URL.createObjectURL(blob);
                const fileName = file.name.replace(/\.[^/.]+$/, "") + ".docx";
                
                downloadLink.href = url;
                downloadLink.download = fileName;
                
                status.innerText = "変換できました！";
                resultArea.style.display = "block";
            };
            reader.readAsText(file); // RTFは基本テキストベース

        } catch (err) {
            status.innerText = "エラー: " + err.message;
        }
    }

    // 簡易的なRTF→テキスト抽出（日本語の文字化け回避を試みる）
    function convertRtfToPseudoHtml(rtf) {
        // RTFの制御文を除去し、プレーンテキストに近い形にする簡易ロジック
        let text = rtf.replace(/\\rtf1|\\ansicpg\d+|\\deff\d+|\\fonttbl[\s\S]*?\}|\\colortbl[\s\S]*?\}|\\stylesheet[\s\S]*?\}|\\info[\s\S]*?\}/g, "");
        text = text.replace(/\\par/g, "<br>"); // 改行の処理
        text = text.replace(/\\f\d+|\\fs\d+|\\cf\d+|\\lang\d+/g, ""); // 装飾タグの除去
        text = text.replace(/\{|\}/g, ""); // ブラケットの除去
        
        // RTF特有の日本語エスケープ (\'82\'a0 等) をデコードする（簡易版）
        return text.replace(/\\'[0-9a-fA-F]{2}/g, (match) => {
            return ""; // ここでは簡易化のため除去。ブラウザの自動認識に期待
        }).trim();
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTF to Word 変換 Ver 4.0</title>
    <style>
        body { font-family: sans-serif; background-color: #333; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { background: #444; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 450px; text-align: center; border: 1px solid #666; }
        h1 { color: #81c784; margin-bottom: 2rem; }
        #drop-zone { border: 2px dashed #81c784; border-radius: 12px; padding: 40px 20px; cursor: pointer; background: #555; margin-bottom: 1rem; }
        #status { margin-top: 1.5rem; color: #fff; font-size: 0.9rem; background: #222; padding: 10px; border-radius: 5px; text-align: left; font-family: monospace; }
        .loader { border: 4px solid #666; border-top: 4px solid #81c784; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #download-btn { display: none; margin-top: 20px; text-decoration: none; background: #2e7d32; color: white; padding: 15px 30px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h1>RTF → Word 変換 V4</h1>
    <div id="drop-zone">ここにRTFをドロップ<br>(またはクリック)</div>
    <input type="file" id="file-input" style="display:none" accept=".rtf">
    <div id="loader" class="loader"></div>
    <div id="status">ログ: 待機中...</div>
    <a id="download-btn">Wordファイルを保存する</a>
</div>

<script type="module">
    // キャッシュ回避のためクエリパラメータを追加
    const timestamp = new Date().getTime();
    import { Pandoc } from "https://unpkg.com/pandoc-wasm@0.1.7/dist/index.js?" + timestamp;

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');
    const downloadBtn = document.getElementById('download-btn');

    function log(msg) {
        console.log(msg);
        status.innerText = "ログ: " + msg;
    }

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#fff"; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = "#81c784"; };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        handleFile(e.dataTransfer.files[0]);
    };

    async function handleFile(file) {
        if (!file) return;
        downloadBtn.style.display = "none";
        loader.style.display = "block";
        log("ファイル読込開始: " + file.name);

        try {
            log("変換エンジン(Wasm)を初期化中...");
            const pandoc = new Pandoc();
            await pandoc.init();
            
            log("データを読み込んでいます...");
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            log("Word形式に変換中（数秒かかります）...");
            const result = await pandoc.run({
                arguments: ['-f', 'rtf', '-t', 'docx', '-o', 'output.docx', 'input.rtf'],
                files: { "input.rtf": uint8Array }
            });

            log("変換完了。中身を検証中...");
            const docxData = result.files["output.docx"];

            if (!docxData || docxData[0] !== 0x50 || docxData[1] !== 0x4B) {
                throw new Error("Word形式の生成に失敗しました。RTFの中身が不正かもしれません。");
            }

            const blob = new Blob([docxData], { type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
            const url = URL.createObjectURL(blob);
            const newFileName = file.name.replace(/\.[^/.]+$/, "") + ".docx";
            
            downloadBtn.href = url;
            downloadBtn.download = newFileName;
            downloadBtn.style.display = "block";
            
            log("完了！下のボタンを押してください。");
        } catch (error) {
            log("エラー発生: " + error.message);
            console.error(error);
        } finally {
            loader.style.display = "none";
        }
    }
</script>

</body>
</html>
